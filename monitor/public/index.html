<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템 모니터링 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .status-healthy { color: #28a745; }
        .status-unhealthy { color: #dc3545; }
        .status-unreachable { color: #6c757d; }
        .metric-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .loading {
            opacity: 0.5;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">시스템 모니터링 대시보드</h1>

        <div class="row">
            <!-- 서비스 상태 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">서비스 상태</h5>
                    </div>
                    <div class="card-body" id="services-status">
                        <div class="d-flex justify-content-between mb-2">
                            <span>API 서버:</span>
                            <span id="api-status">확인 중...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>클라이언트:</span>
                            <span id="client-status">확인 중...</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>프록시:</span>
                            <span id="proxy-status">확인 중...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 시스템 리소스 -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">시스템 리소스</h5>
                    </div>
                    <div class="card-body" id="system-resources">
                        <div class="d-flex justify-content-between mb-2">
                            <span>메모리 사용량:</span>
                            <span id="memory-usage">확인 중...</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>CPU 사용량:</span>
                            <span id="cpu-usage">확인 중...</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>가동 시간:</span>
                            <span id="uptime">확인 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메트릭스 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">실시간 메트릭스</h5>
                    </div>
                    <div class="card-body">
                        <div id="metrics-container">
                            <!-- 메트릭스가 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Socket.IO 연결 설정
            const socket = io('/', {
                path: '/socket.io'
            });

            // 연결 상태 처리
            socket.on('connect', () => {
                console.log('Socket.IO 서버에 연결되었습니다.');
            });

            socket.on('connect_error', (error) => {
                console.error('Socket.IO 연결 오류:', error);
            });

            // 데이터 업데이트 함수들
            function updateServiceStatus(service, info) {
                const element = document.getElementById(`${service}-status`);
                if (!element) return;

                const statusClass = `status-${info.status}`;
                element.className = statusClass;
                element.textContent = `${info.status} (${info.responseTime}ms)${info.message ? ` - ${info.message}` : ''}`;
            }

            function updateSystemResources(data) {
                if (!data || !data.system) {
                    console.error('시스템 데이터가 유효하지 않습니다:', data);
                    return;
                }

                const { memory, cpu, uptime } = data.system;

                try {
                    // 메모리 사용량 표시 (MB 단위로 변환)
                    const memoryUsed = Math.round(memory.heapUsed / 1024 / 1024);
                    const memoryTotal = Math.round(memory.heapTotal / 1024 / 1024);
                    document.getElementById('memory-usage').textContent =
                        `${memoryUsed}MB / ${memoryTotal}MB`;

                    // CPU 사용량 표시
                    const cpuUsage = Math.round((cpu.user + cpu.system) / 1000);
                    document.getElementById('cpu-usage').textContent =
                        `${cpuUsage}ms`;

                    // 가동 시간 표시
                    const uptimeHours = Math.floor(uptime / 3600);
                    const uptimeMinutes = Math.floor((uptime % 3600) / 60);
                    document.getElementById('uptime').textContent =
                        `${uptimeHours}시간 ${uptimeMinutes}분`;
                } catch (error) {
                    console.error('시스템 리소스 업데이트 중 오류:', error);
                }
            }

            function updateMetrics(metrics) {
                const container = document.getElementById('metrics-container');
                if (!container) return;

                container.innerHTML = ''; // 기존 메트릭스 초기화

                try {
                    if (Array.isArray(metrics)) {
                        metrics.forEach(metric => {
                            const metricElement = document.createElement('div');
                            metricElement.className = 'metric-card';
                            metricElement.innerHTML = `
                                <h6>${metric.name}</h6>
                                <p class="text-muted">${metric.help}</p>
                                <p class="mb-0">값: ${metric.values[0]?.value || 'N/A'}</p>
                            `;
                            container.appendChild(metricElement);
                        });
                    } else {
                        const metricElement = document.createElement('div');
                        metricElement.className = 'metric-card';
                        metricElement.innerHTML = `
                            <p class="text-muted">메트릭스 데이터를 불러오는 중...</p>
                        `;
                        container.appendChild(metricElement);
                    }
                } catch (error) {
                    console.error('메트릭스 업데이트 중 오류:', error);
                    container.innerHTML = `
                        <div class="error-message">
                            메트릭스 데이터를 표시하는 중 오류가 발생했습니다.
                        </div>
                    `;
                }
            }

            // 실시간 데이터 수신
            socket.on('metrics', (data) => {
                console.log('메트릭스 데이터 수신:', data);
                updateMetrics(data);
            });

            // 초기 데이터 로드 및 주기적 업데이트
            async function fetchData() {
                try {
                    const response = await fetch('/api/monitor');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // 서비스 상태 업데이트
                    if (data.services) {
                        Object.entries(data.services).forEach(([service, info]) => {
                            updateServiceStatus(service, info);
                        });
                    }

                    // 시스템 리소스 업데이트
                    updateSystemResources(data);
                } catch (error) {
                    console.error('데이터 로드 중 오류:', error);
                    // 에러 상세 로깅
                    console.error('상세 에러:', error.message);

                    // 에러 상태 표시
                    document.querySelectorAll('[id$="-status"]').forEach(element => {
                        element.className = 'status-unreachable';
                        element.textContent = '연결 오류';
                    });
                }
            }

            // 페이지 로드 시 초기 데이터 로드
            fetchData();

            // 10초마다 데이터 업데이트
            setInterval(fetchData, 10000);
        });
    </script>
</body>
</html>
